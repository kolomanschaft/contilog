@page "/topics"
@using Contilog.Models
@using Contilog.Repositories
@using System.Linq
@inject ITopicRepository TopicRepository
@inject IPostRepository PostRepository
@inject NavigationManager Navigation

<PageTitle>Topics</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Topics</h1>
    <button class="btn @(archiveMode ? "btn-outline-primary" : "btn-primary")" @onclick="ToggleArchiveMode">
        <span class="oi @(archiveMode ? "oi-arrow-left" : "oi-box")" aria-hidden="true"></span>
        @(archiveMode ? "Back" : "Archive")
    </button>
</div>

@if (topics == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    @foreach (var category in categories)
    {
        <div class="category-container">
            <div class="card topics-card">
                <div class="card-header topics-card-header">
                    <h5 class="card-title topics-card-title">@category</h5>
                </div>
                <div class="card-body topics-card-body">
                    <QuickGrid Items="@GetTopicsByCategory(category)" Class="table topics-table topics-grid">
                        <TemplateColumn Title="Topics" Sortable="true" SortBy="@(GridSort<Topic>.ByAscending(t => t.Title))">
                            <div class="@(context.IsActive ? "" : "text-muted")">
                                @context.Title
                            </div>
                        </TemplateColumn>
                        <TemplateColumn Title="Author" Sortable="true" SortBy="@(GridSort<Topic>.ByAscending(t => t.Author))">
                            <div class="@(context.IsActive ? "" : "text-muted")">
                                @context.Author
                            </div>
                        </TemplateColumn>
                        <TemplateColumn Title="Posts" Sortable="true" SortBy="@(GridSort<Topic>.ByDescending(t => GetPostCount(t.Id)))">
                            <div class="@(context.IsActive ? "" : "text-muted") text-center">
                                @GetPostCount(context.Id)
                            </div>
                        </TemplateColumn>
                        <TemplateColumn Title="Actions">
                            <div class="topics-action-cell">
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ViewPosts(context.Id)" title="View Posts">
                                    <span class="oi oi-eye" aria-hidden="true"></span>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTopic(context.Id)" title="Delete Topic">
                                    <span class="oi oi-trash" aria-hidden="true"></span>
                                </button>
                            </div>
                        </TemplateColumn>
                    </QuickGrid>
                </div>
            </div>
        </div>
    }
}

@code {
    private bool archiveMode = false;
    private List<Topic>? topics;
    private Dictionary<int, int> postCounts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTopicsAsync();
    }

    private async Task LoadTopicsAsync()
    {
        var allTopics = await TopicRepository.GetAllTopicsAsync();
        topics = allTopics.ToList();

        // Load post counts for all topics
        postCounts.Clear();
        foreach (var topic in topics)
        {
            var count = await PostRepository.GetPostCountByTopicIdAsync(topic.Id);
            postCounts[topic.Id] = count;
        }

        StateHasChanged();
    }

    // Extract unique categories and sort them alphabetically
    private List<string> categories => topics?
        .Where(t => t.IsActive != archiveMode)
        .Select(t => t.Category)
        .Distinct()
        .OrderBy(c => c)
        .ToList() ?? new List<string>();

    // Filter topics by category
    private IQueryable<Topic> GetTopicsByCategory(string category)
    {
        if (topics == null) return new List<Topic>().AsQueryable();

        return topics
            .Where(t => t.Category == category)
            .Where(t => t.IsActive != archiveMode)
            .OrderByDescending(t => t.IsActive)
            .ThenByDescending(t => t.CreatedDate)
            .AsQueryable();
    }

    private int GetPostCount(int topicId)
    {
        return postCounts.TryGetValue(topicId, out var count) ? count : 0;
    }

    private async Task DeleteTopic(int topicId)
    {
        var success = await TopicRepository.DeleteTopicAsync(topicId);
        if (success)
        {
            await LoadTopicsAsync(); // Reload topics after deletion
        }
        else
        {
            // TODO: Show error message to user
            Console.WriteLine($"Failed to delete topic with ID: {topicId}");
        }
    }

    private void ViewPosts(int topicId)
    {
        Navigation.NavigateTo($"/topics/{topicId}");
    }

    private void ToggleArchiveMode()
    {
        archiveMode = !archiveMode;
    }
}

