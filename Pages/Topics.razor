@page "/topics"
@using Contilog.Models
@using Contilog.Handlers.Topics
@using Contilog.Handlers.Categories
@using Contilog.Handlers.Posts
@using System.Linq
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.AspNetCore.Components.Web
@inject IGetAllTopicsHandler GetAllTopicsHandler
@inject IGetTopicByIdHandler GetTopicByIdHandler
@inject ICreateTopicHandler CreateTopicHandler
@inject IArchiveTopicHandler ArchiveTopicHandler
@inject IDeleteTopicHandler DeleteTopicHandler
@inject IGetAllCategoriesHandler GetAllCategoriesHandler
@inject IGetPostCountByTopicIdHandler GetPostCountByTopicIdHandler
@inject NavigationManager Navigation

<PageTitle>Topics</PageTitle>

<div class="topics-header">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Topics</h1>
        <button class="btn btn-outline-secondary" @onclick="ToggleArchiveVisibility">
            <span class="oi @(showArchived ? "oi-eye-closed" : "oi-eye")" aria-hidden="true"></span>
            @(showArchived ? "Hide archived" : "Show archived")
        </button>
    </div>
</div>

@if (topics == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    @foreach (var category in GetVisibleCategories())
    {
        <div class="category-container">
            <div class="card topics-card">
                <div class="card-header topics-card-header">
                    <h5 class="card-title topics-card-title @(category.IsActive ? "" : "text-muted")">
                        @category.Name
                        @if (!category.IsActive)
                        {
                            <span class="badge bg-secondary ms-2">Archived</span>
                        }
                    </h5>
                </div>
                <div class="card-body topics-card-body">
                    <QuickGrid Items="@GetTopicsByCategory(category)" Class="table topics-table topics-grid">
                        <TemplateColumn Title="Topics" Sortable="true" SortBy="@(GridSort<Topic>.ByAscending(t => t.Title))">
                            <div class="@(context.IsActive ? "" : "text-muted")">
                                @context.Title
                                @if (!context.IsActive)
                                {
                                    <span class="badge bg-secondary ms-2">Archived</span>
                                }
                            </div>
                        </TemplateColumn>
                        <TemplateColumn Title="Author" Sortable="true" SortBy="@(GridSort<Topic>.ByAscending(t => t.Author))">
                            <div class="@(context.IsActive ? "" : "text-muted")">
                                @context.Author
                            </div>
                        </TemplateColumn>
                        <TemplateColumn Title="Posts" Sortable="true" SortBy="@(GridSort<Topic>.ByDescending(t => GetPostCount(t.Id)))">
                            <div class="@(context.IsActive ? "" : "text-muted") text-center">
                                @GetPostCount(context.Id)
                            </div>
                        </TemplateColumn>
                        <TemplateColumn>
                            <div class="topics-action-cell">
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ViewPosts(context.Id)" title="Write Posts">
                                    <span class="oi oi-pencil" aria-hidden="true"></span>
                                </button>
                                @if (context.IsActive)
                                {
                                    <button class="btn btn-sm btn-outline-warning" @onclick="() => ShowArchiveConfirmation(context.Id)" title="Archive Topic">
                                        <span class="oi oi-box" aria-hidden="true"></span>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => ShowDeleteConfirmation(context.Id)" title="Delete Topic">
                                        <span class="oi oi-trash" aria-hidden="true"></span>
                                    </button>
                                }
                            </div>
                        </TemplateColumn>
                    </QuickGrid>
                    
                    @if (addingTopicToCategoryId == category.Id)
                    {
                        <div class="py-2 border-top">
                            <div class="d-flex align-items-center gap-2 ps-2">
                                <input type="text" class="form-control form-control-sm topic-input" @bind="newTopicTitle" @onkeypress="OnNewTopicKeyPress" placeholder="Enter topic title..." />
                                <button class="btn btn-sm btn-success flex-shrink-0" @onclick="() => SaveNewTopic(category.Id)" title="Save Topic">
                                    <span class="oi oi-check" aria-hidden="true"></span>
                                </button>
                                <button class="btn btn-sm btn-secondary flex-shrink-0 me-2" @onclick="CancelNewTopic" title="Cancel">
                                    <span class="oi oi-x" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>
                    }
                    
                    @if (category.IsActive && addingTopicToCategoryId != category.Id)
                    {
                        <div class="mt-1 mb-2 ps-2">
                            <button class="btn btn-outline-primary" @onclick="() => StartAddingTopic(category.Id)" title="Add Topic">
                                <span class="oi oi-plus" aria-hidden="true"></span>
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
}

<ConfirmationDialog 
    IsVisible="showArchiveConfirmation"
    Title="Confirm Topic Archive"
    Message="Are you sure you want to archive this topic? It will be hidden from the active view but can be restored later."
    ConfirmText="Archive"
    CancelText="Cancel"
    ConfirmButtonClass="btn-warning"
    OnConfirmed="ConfirmArchiveTopic"
    OnCancelled="HideArchiveConfirmation" />

<ConfirmationDialog 
    IsVisible="showDeleteConfirmation"
    Title="Confirm Topic Deletion"
    Message="Are you sure you want to delete this topic and all its posts? This action cannot be undone."
    ConfirmText="Delete"
    CancelText="Cancel"
    ConfirmButtonClass="btn-danger"
    OnConfirmed="ConfirmDeleteTopic"
    OnCancelled="HideDeleteConfirmation" />

@code {
    private bool showArchived = false;
    private List<Topic>? topics = new();
    private List<Category>? categories = new();
    private Dictionary<int, int> postCounts = new();
    
    // Archive confirmation
    private bool showArchiveConfirmation = false;
    private int topicToArchiveId = 0;
    
    // Delete confirmation
    private bool showDeleteConfirmation = false;
    private int topicToDeleteId = 0;
    
    // Add new topic
    private int? addingTopicToCategoryId = null;
    private string newTopicTitle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTopics();
    }

    private async Task LoadTopics()
    {
        var getAllCategoriesRequest = new GetAllCategoriesRequest();
        var getAllCategoriesResponse = await GetAllCategoriesHandler.Handle(getAllCategoriesRequest);
        categories = getAllCategoriesResponse.Categories.ToList();
        
        var getAllTopicsRequest = new GetAllTopicsRequest();
        var getAllTopicsResponse = await GetAllTopicsHandler.Handle(getAllTopicsRequest);
        topics = getAllTopicsResponse.Topics.ToList();
        postCounts.Clear();
        foreach (var topic in topics)
        {
            var getPostCountRequest = new GetPostCountByTopicIdRequest(topic.Id);
            var getPostCountResponse = await GetPostCountByTopicIdHandler.Handle(getPostCountRequest);
            postCounts[topic.Id] = getPostCountResponse.Count;
        }

        StateHasChanged();
    }

    // Filter topics by category
    private IQueryable<Topic> GetTopicsByCategory(Category category)
    {
        if (topics == null) return new List<Topic>().AsQueryable();

        var filteredTopics = topics.Where(t => t.CategoryId == category.Id);
        
        if (!showArchived)
        {
            // Only show active topics when showArchived is false
            filteredTopics = filteredTopics.Where(t => t.IsActive);
        }
        // When showArchived is true, show both active and archived topics
        
        return filteredTopics
            .OrderByDescending(t => t.IsActive) // Active topics first
            .ThenBy(t => t.CreatedDate)
            .AsQueryable();
    }

    // Filter categories based on archive visibility
    private IEnumerable<Category> GetVisibleCategories()
    {
        if (categories == null) return new List<Category>();

        var filteredCategories = categories.AsEnumerable();
        
        if (!showArchived)
        {
            // Only show active categories when showArchived is false
            filteredCategories = categories.Where(c => c.IsActive);
        }
        // When showArchived is true, show both active and archived categories
        return filteredCategories.OrderBy(c => c.Name);
    }

    private int GetPostCount(int topicId)
    {
        return postCounts.TryGetValue(topicId, out var count) ? count : 0;
    }

    private void ShowArchiveConfirmation(int topicId)
    {
        topicToArchiveId = topicId;
        showArchiveConfirmation = true;
        StateHasChanged();
    }

    private void HideArchiveConfirmation()
    {
        showArchiveConfirmation = false;
        topicToArchiveId = 0;
        StateHasChanged();
    }

    private async Task ConfirmArchiveTopic()
    {
        showArchiveConfirmation = false;
        if (topicToArchiveId > 0)
        {
            await ArchiveTopic(topicToArchiveId);
        }
        topicToArchiveId = 0;
        StateHasChanged();
    }

    private void ShowDeleteConfirmation(int topicId)
    {
        topicToDeleteId = topicId;
        showDeleteConfirmation = true;
        StateHasChanged();
    }

    private void HideDeleteConfirmation()
    {
        showDeleteConfirmation = false;
        topicToDeleteId = 0;
        StateHasChanged();
    }

    private async Task ConfirmDeleteTopic()
    {
        showDeleteConfirmation = false;
        if (topicToDeleteId > 0)
        {
            await DeleteTopic(topicToDeleteId);
        }
        topicToDeleteId = 0;
        StateHasChanged();
    }

    private async Task ArchiveTopic(int topicId)
    {
        var archiveTopicRequest = new ArchiveTopicRequest(topicId);
        var archiveTopicResponse = await ArchiveTopicHandler.Handle(archiveTopicRequest);
        if (archiveTopicResponse.Success)
        {
            await LoadTopics(); // Reload topics after archiving
        }
        else
        {
            // TODO: Show error message to user
            Console.WriteLine($"Failed to archive topic with ID: {topicId}");
        }
    }

    private async Task DeleteTopic(int topicId)
    {
        var deleteTopicRequest = new DeleteTopicRequest(topicId);
        var deleteTopicResponse = await DeleteTopicHandler.Handle(deleteTopicRequest);
        if (deleteTopicResponse.Success)
        {
            await LoadTopics(); // Reload topics after deletion
        }
        else
        {
            // TODO: Show error message to user
            Console.WriteLine($"Failed to delete topic with ID: {topicId}");
        }
    }

    private void ViewPosts(int topicId)
    {
        Navigation.NavigateTo($"/topics/{topicId}");
    }

    private void ToggleArchiveVisibility()
    {
        showArchived = !showArchived;
        StateHasChanged();
    }

    private void StartAddingTopic(int categoryId)
    {
        addingTopicToCategoryId = categoryId;
        newTopicTitle = string.Empty;
        StateHasChanged();
    }

    private void CancelNewTopic()
    {
        addingTopicToCategoryId = null;
        newTopicTitle = string.Empty;
        StateHasChanged();
    }

    private async Task SaveNewTopic(int categoryId)
    {
        if (!string.IsNullOrWhiteSpace(newTopicTitle))
        {
            var createTopicRequest = new CreateTopicRequest(
                newTopicTitle.Trim(),
                categoryId,
                "Kylo Ren" // TODO: Get from authentication
            );

            var createTopicResponse = await CreateTopicHandler.Handle(createTopicRequest);
            if (createTopicResponse.Success && createTopicResponse.Topic != null)
            {
                // Add to local list
                topics?.Add(createTopicResponse.Topic);
                
                // Initialize post count for new topic
                postCounts[createTopicResponse.Topic.Id] = 0;
                
                // Exit add mode
                addingTopicToCategoryId = null;
                newTopicTitle = string.Empty;
                StateHasChanged();
            }
            else
            {
                // TODO: Show error message to user
                Console.WriteLine("Failed to create new topic");
            }
        }
    }

    private async Task OnNewTopicKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && addingTopicToCategoryId.HasValue)
        {
            await SaveNewTopic(addingTopicToCategoryId.Value);
        }
        else if (e.Key == "Escape")
        {
            CancelNewTopic();
        }
    }
}

